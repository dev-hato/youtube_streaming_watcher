---
name: clean-cache

on:
  pull_request:

jobs:
  clean-cache:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6.3.3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const actionsGetActionsCacheUsageParams = {
              owner: context.repo.owner,
              repo: context.repo.repo,
            }
            console.log('call actions.getActionsCacheUsage', actionsGetActionsCacheUsageParams)
            const actionsCacheUsage = await github.rest.actions.getActionsCacheUsage(actionsGetActionsCacheUsageParams)
            if (9 * 1024 * 1024 * 1024 < actionsCacheUsage.data.active_caches_size_in_bytes) {
              const actionsGetActionsCacheListParams = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                sort: 'last_accessed_at',
                direction: 'asc',
              }
              console.log('call actions.getActionsCacheList', actionsGetActionsCacheListParams)
              const actionsGetActionsCacheList = await github.rest.actions.getActionsCacheList(actionsGetActionsCacheListParams)
              console.log(actionsGetActionsCacheList.data.actions_caches[0].key)
            }

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true
